function AuthorizationError(a){this.name="Not Authorized",this.message=a||"Not authorized for the current user (no matching authorization token)",this.stack=(new Error).stack}function assert(a,b){if(!a)throw new Error(b||"failed")}function AuthorizationError(a){this.name="Not Authorized",this.message=a||"Not authorized for the current user (no matching authorization token)",this.stack=(new Error).stack}var Cloudwalkers={apiurl:"https://devapi.cloudwalkers.be/1/",appid:"oauth253df6850dec638.12776363",Views:{},Router:{},Models:{},Collections:{},Utilities:{},init:function(){var a=window.localStorage.getItem("token");a&&a.length>9?Cloudwalkers.Session.authenticationtoken=a:window.location="/login.html",Cloudwalkers.Session.api=config.apiurl,Cloudwalkers.Session.loadEssentialData(function(){Cloudwalkers.RootView=new Cloudwalkers.Views.Root,Cloudwalkers.Router.Instance=new Cloudwalkers.Router,Backbone.history.start()}),this.config=config},hasToken:function(){Store.get("settings","token",function(a){a?Cloudwalkers.hello():(Cloudwalkers.setloginwindow(),window.addEventListener("message",Cloudwalkers.receiveToken,!1))})},receiveToken:function(a){a.origin===window.location.origin&&Store.set("settings",{key:"token",value:a.data},hello)},setloginwindow:function(){$("iframe").get(0).src=config.authurl+"authorize?response_type=token&state=xyz&client_id="+config.appid+"&redirect_uri="+encodeURIComponent(origin()+"/auth.html")},hello:function(){window.location="/"}};AuthorizationError.prototype=new Error,AuthorizationError.prototype.constructor=AuthorizationError,Backbone.ajax=function(){return Cloudwalkers.Session.authenticationtoken&&(arguments[0].headers={Authorization:"Bearer "+Cloudwalkers.Session.authenticationtoken,Accept:"application/json"}),Backbone.$.ajax.apply(Backbone.$,arguments)},Backbone.Model=Backbone.Model.extend({url:function(){return this.endpoint?Cloudwalkers.config.apiurl+"admin/"+this.typestring+"/"+this.id+this.endpoint:Cloudwalkers.config.apiurl+this.typestring+"/"+this.id},sync:function(a,b,c){return"update"==a?!1:Backbone.sync(a,b,c)}}),Backbone.Collection=Backbone.Collection.extend({typestring:"accounts",distantAdd:function(a){this.get(a.id)||this.add(a)},url:function(){this.parentmodel&&!this.parenttype&&(this.parenttype=this.parentmodel.get("objectType"));var a=this.parentmodel?Cloudwalkers.config.apiurl+"admin/"+this.parenttype+"/"+this.parentmodel.id:Cloudwalkers.config.apiurl+"admin/"+this.typestring;return this.endpoint&&(a+="/"+this.endpoint),this.parameters?a+"?"+$.param(this.parameters):a},sync:function(a,b,c){return"update"==a?!1:Backbone.sync(a,b,c)},parse:function(a){return this.parentmodel&&!this.parenttype&&(this.parenttype=this.parentmodel.get("objectType")),this.parentmodel&&(a=a[this.parenttype]),a&&this.setcursor(a.paging),a.paging||this.ready(),a[this.typestring]},setcursor:function(a){return a?void(this.cursor=a.cursors?a.cursors.after:!1):!1},updates:function(a){for(var b in a){var c=this.get(a[b]);c&&c.get("objectType")&&(Store.set(this.typestring,{id:a[b],outdated:!0}),c.outdated=!0,c.trigger("outdated"))}},outdated:function(a){if(!a)return this.filter(function(a){return a.outdated});this.updates([a])},touch:function(a,b){this.parentmodel=a,this.endpoint=this.modelstring+"ids",this.parameters=b,this.fetch({success:this.touchresponse.bind(this,this.url())})},touchlocal:function(a){a&&a.modelids.length?(this.cursor=a.cursor,this.seed(a.modelids),this.ready()):this.fetch({success:this.touchresponse.bind(this,this.url())})},touchresponse:function(a,b,c){var d=c[this.parenttype][this.typestring];Store.set("touches",{id:a,modelids:d,cursor:this.cursor,ping:Cloudwalkers.Session.getPing().cursor}),this.seed(d)},seed:function(a){a||(a=[]);var b=[],c=_.compact(a.map(function(a){var c=this.get(a);return c||(c=Cloudwalkers.Session.user.account[this.typestring].get(a)),c?this.add(c):c=this.create({id:a}),b.push(c),a},this));return c.length&&(this.endpoint=this.parentmodel?this.typestring:null,this.parameters={ids:c.join(",")},this.fetch({remove:!1})),this.trigger("seed",b),b},more:function(a,b){return this.cursor?(b.after=this.cursor,this.touch(a,b),this):!1},ready:function(){setTimeout(function(a){a.trigger("ready",a)},1,this)}});var origin=function(){return window.location.origin?window.location.origin:window.location.protocol+"//"+window.location.hostname};$(function(){Cloudwalkers.Collections.Accounts=Backbone.Collection.extend({model:Cloudwalkers.Models.Account,initialize:function(){},parse:function(a){return a},updates:function(a){for(var b in a){var c=this.get(a[b]);c&&(Store.set(this.typestring,{id:a[b],outdated:!0}),c.fetch())}},outdated:function(a){if(!a)return this.filter(function(a){return a.outdated});this.updates([a])}})}),Cloudwalkers.Models.Account=Backbone.Model.extend({typestring:"accounts",initialize:function(){},parse:function(a){return a.account?a.account:a},url:function(){return CONFIG_BASE_URL+"json/account/"+this.id+this.endpoint},sync:function(a,b,c){return Backbone.sync(a,b,c)},firstload:function(){$.each(this.get("channels"),function(a,b){Cloudwalkers.Session.storeChannel(b)})},activate:function(){Store.exists("channels")||this.firstload(),Store.filter("streams",null,function(a){this.streams.add(a)}.bind(this)),Store.filter("channels",null,function(a){this.channels.add(a)}.bind(this)),Store.filter("campaigns",null,function(a){this.campaigns.add(a)}.bind(this)),Store.filter("users",null,function(a){this.users.add(a)}.bind(this)),Store.filter("messages",null,function(a){this.messages.add(a)}.bind(this)),Store.filter("statistics",null,function(a){this.statistics.add(a)}.bind(this)),Store.filter("reports",null,function(a){this.reports.add(a)}.bind(this)),this.get("plan")&&(this.limits=this.get("plan").limits),this.ping=new Cloudwalkers.Session.Ping({id:this.id})},monitorlimit:function(a,b,c){return b>=this.limits[a]?($(".alert-info").remove(),Cloudwalkers.RootView.information("Upgrade?","You're fresh out of "+a+" slots, maybe you should upgrade."),c&&("string"==typeof c&&(c=$(c)),c.addClass("limited").attr("disabled",!0)),!0):($("[disabled].limited").size()&&($("[disabled].limited").removeClass("limited").attr("disabled",!1),$("[data-dismiss=alert]").click()),!1)},addcampaign:function(a,b){var c=this.get("campaigns");c.map(function(a){return a.name}).indexOf(a)<0&&(c.push({name:a}),this.save({campaigns:c},{patch:!0,wait:!0,success:b}))},removecampaign:function(a,b){var c=this.get("campaigns");c.forEach(function(b,d){b.id==a&&c.splice(d,1)}),this.save({campaigns:c},{patch:!0,wait:!0,success:b})}}),$(function(){Cloudwalkers.Models.Me=Cloudwalkers.Models.User.extend({unreadMessages:null,initialize:function(){this.once("change",this.activate),this.on("change:id",function(){this.previous("id")&&Cloudwalkers.Session.home()})},url:function(){return"https://devapi.cloudwalkers.be/1/users/me?include_accounts=ids"},parse:function(a){return a.user},firstload:function(a){return a.settings.currentAccount||(a.settings={currentAccount:a.accounts[0].id}),a},activate:function(){return this.get("accounts").length?void Store.filter("accounts",null,function(a){this.accounts=new Cloudwalkers.Collections.Accounts(a),this.account=this.getCurrentAccount(),this.account.activate(),this.set("level",Number(this.account.get("currentuser").level)),this.set("rolegroup",Number(this.account.get("currentuser").rolegroup)),this.authorized=this.account.get("currentuser").authorized,this.removerole("ACCOUNT_TAGS_MANAGE"),this.removerole("ACCOUNT_TAGS_VIEW"),this.parseauthorized(),this.censuretokens=this.censure(this.authorized),this.trigger("activated")}.bind(this)):Cloudwalkers.RootView.exception(401)},isauthorized:function(a){return _.isArray(a)?0!==_.intersection(this.authorized,a).length:_.contains(this.authorized,a)},removerole:function(a){var b=this.authorized.indexOf(a);b>=0&&this.authorized.splice(b-1,b+1)},censure:function(a){var b={};for(var c in a)b[a[c]]=!0;return b},parseauthorized:function(){this.isauthorized(["MESSAGE_OUT_EDIT_OWN","MESSAGE_ACTIONS"])&&this.authorized.push("_CW_COWORKERS_VIEW"),this.isauthorized(["MESSAGE_READ_INBOX_MESSAGES","MESSAGE_READ_INBOX_NOTIFICATIONS","MESSAGE_READ_SCHEDULE","MESSAGE_READ_DRAFTS","ACCOUNT_NOTES_VIEW"])&&this.authorized.push("_CW_INBOX_VIEW")},offline:function(){Store.exists("me")&&this.trigger("change")},getCurrentAccount:function(){var a=Cloudwalkers.Session.get("currentAccount");a||(a=this.accounts.at(0).id,this.save({settings:{currentAccount:a}}));var b=this.accounts.get(Number(a));return b&&b.id?b:(this.save({settings:{currentAccount:this.accounts.at(0).id}}),Cloudwalkers.Session.home())}})}),Cloudwalkers.Models.User=Backbone.Model.extend({typestring:"users",initialize:function(){},url:function(){return this.parent?CONFIG_BASE_URL+"json/"+this.parent.typestring+"/"+this.parent.id+"/"+this.typestring+"/"+this.id:CONFIG_BASE_URL+"json/user/"+this.id},filterData:function(a){var b=this.attributes;return"listitem"==a?b.arrow=!0:b.role=this.getRole(),b},getcoworker:function(){},getRole:function(){var a=Cloudwalkers.Session.getAccount().get("roles"),b=this.get("rolegroup");if(!a||_.isUndefined(b))return Cloudwalkers.RootView.resync("#"+Backbone.history.fragment);var c=a.filter(function(a){return a.id==b});return c.length?c[0]:null}}),Cloudwalkers.Router=Backbone.Router.extend({routes:{statistics:"statistics",accounts:"accounts","accounts/plans":"accounts_plans",users:"users","users/roles":"users_roles","performance/little":"little_ken",performance:"performance","performance/servers":"performance_servers","performance/logs":"performance_logs",logout:"logout","*path":"dashboard"},initialize:function(){},dashboard:function(){Cloudwalkers.RootView.setView(new Cloudwalkers.Views.Dashboard)},statistics:function(){this.navigate("#dashboard",!0)},firsttime:function(){Cloudwalkers.RootView.setView(new Cloudwalkers.Views.Firsttime)},exception:function(){},accounts:function(){this.navigate("#dashboard",!0)},accounts_plans:function(){this.navigate("#dashboard",!0)},users:function(){this.navigate("#dashboard",!0)},users_roles:function(){this.navigate("#dashboard",!0)},little_ken:function(){Cloudwalkers.RootView.setView(new Cloudwalkers.Views.Little)},streams_scheduling:function(){this.navigate("#dashboard",!0)},performance:function(){this.navigate("#dashboard",!0)},performance_servers:function(){this.navigate("#dashboard",!0)},performance_logs:function(){this.navigate("#dashboard",!0)},logout:function(){$.ajax({url:Cloudwalkers.config.authurl+"revoke",headers:{Authorization:"Bearer "+Cloudwalkers.Session.authenticationtoken,Accept:"application/json"},success:function(){window.location="/"}}),Cloudwalkers.RootView.view.remove(),Cloudwalkers.RootView.navigation.remove(),window.localStorage.clear()}}),Cloudwalkers.Session={user:null,resynced:!1,initialize:function(){this.accounts=new Cloudwalkers.Collections.Accounts},isLoaded:function(){return null!=this.user},loadEssentialData:function(a){this.user=new Cloudwalkers.Models.Me,this.user.fetch({success:a,error:this.logout})},refresh:function(){console.log("Session.refresh triggered")},reset:function(){window.localStorage.clear()},home:function(){Cloudwalkers.Router.Instance.home()},logout:function(){window.localStorage.clear(),this.authenticationtoken&&Store.remove("settings","token",function(){console.log("logged out")})},updateSetting:function(a,b,c){Cloudwalkers.Session.user.attributes.settings[a]!=b&&(Cloudwalkers.Session.user.attributes.settings[a]=b,c=$.extend(c,{patch:!0})||{patch:!0},Cloudwalkers.Session.user.save({settings:Cloudwalkers.Session.user.attributes.settings},c))},get:function(a){return this.user.get("settings")[a]},clone:function(a){if(null==a||"object"!=typeof a)return a;var b=a.constructor();for(var c in a)b[c]=this.clone(a[c]);return b},viewsettings:function(a,b){var c="account_"+this.getAccount().id;Cloudwalkers.Session.user.attributes.settings.viewsettings||(Cloudwalkers.Session.user.attributes.settings.viewsettings={}),Cloudwalkers.Session.user.attributes.settings.viewsettings[c]||(Cloudwalkers.Session.user.attributes.settings.viewsettings[c]=Cloudwalkers.RootView.navigation.mapViews());var d=this.clone(this.get("viewsettings"));if(b){if(a&&b)return d[c][a]=$.extend(d[c][a],b),this.updateSetting("viewsettings",d),d[c][a];throw TypeError("Not the right parameters were met for function viewsettings")}return d[c][a]},manage:function(){var a=Store.count("messages");a>200&&Store.filter("messages",null,function(a){a.sort(function(a,b){return a.stamp>b.stamp?1:a.stamp<b.stamp?-1:0}),a=a.slice(0,100),Store.write("messages",a),Store.filter("touches",null,function(a){var b=Cloudwalkers.Session.getPing().cursor;a=a.filter(function(a){return a.ping==b}),Store.write("touches",a)})});var b=Store.count("reports");b>25&&Store.filter("reports",null,function(a){a.sort(function(a,b){return a.stamp>b.stamp?1:a.stamp<b.stamp?-1:0}),a=a.slice(0,10),Store.write("messages",a)})},isAuthorized:function(a){return a?this.user.isauthorized(a):this.user.authorized},censuretemplate:function(a){a||(a={});var b=this.getUser().censuretokens;a.authorized=b},getPing:function(){return this.user.account.ping},ping:function(a){this.user.account.ping.forceping(a)},getAccount:function(a){return a?this.user.accounts.get(a):this.user.account},getAccounts:function(){return this.user.accounts},getChannel:function(a){return"number"==typeof a?this.user.account.channels.get(a):this.user.account.channels.findWhere({type:a})},getChannels:function(){return this.user.account.channels},storeChannel:function(a){a.channels&&a.channels.length&&(a.channels=a.channels.map(function(a){return Cloudwalkers.Session.storeChannel(a),a.id})),a.streams&&a.streams.length&&(a.streams=a.streams.map(function(a){return Store.post("streams",a),a.id})),Store.post("channels",a)},getStream:function(a){return"number"==typeof a?this.user.account.streams.get(a):this.user.account.streams.findWhere({token:a})},getStreams:function(){return this.user.account.streams},getUser:function(a){return a?this.user.account.users.get(a):this.user},getUsers:function(){return this.user.account.users},getContact:function(a){return this.user.account.contacts.get(a)},getContacts:function(){return this.user.account.contacts},getMessage:function(a){return this.user.account.messages.get(a)},getMessages:function(){return this.user.account.messages},getCannedResponse:function(a){return this.user.account.cannedresponses.get(a)},getCannedResponses:function(){return this.user.account.cannedresponses},getNotification:function(a){return this.user.account.notifications.get(a)},getNotifications:function(){return this.user.account.notifications},getStatistic:function(a){return this.user.account.statistics.get(a)},getStatistics:function(){return this.user.account.statistics},getReport:function(a){return this.user.account.reports.get(a)},getReports:function(){return this.user.account.reports},getComment:function(a){return this.user.account.comments.get(a)},getComments:function(){return this.user.account.comments},setLang:function(){var a,b=this.user.attributes.locale;moment.lang(b),a=new Cloudwalkers.Models.Polyglot,a.fetch({success:function(){this.translationLang=a.get("translation"),this.polyglot=new Polyglot({phrases:this.translationLang}),this.trigger("translation:done")}.bind(this)})}},_.extend(Cloudwalkers.Session,Backbone.Events);var StorageClassIDB=function(a,b,c){var d,e=indexedDB.open(a,b),f=function(a){console.log("IndexedDB error.",a)};e.onerror=function(){console.log("IndexedDB locked.")},e.onsuccess=function(){d=e.result,d.onerror=f,c&&c()},e.onupgradeneeded=IDBstores,this.get=function(a,b,c){var e=d.transaction([a]);e.onerror=f;var g=e.objectStore(a),h=g.get(b);return h.onerror=f,h.onsuccess=function(){c(h.result)},this},this.filter=function(){return this},this.exists=function(){return exists},this.post=function(a,b,c){var d=JSON.parse(window.localStorage.getItem(a));return d||(d=[]),d.push(b),window.localStorage.setItem(a,JSON.stringify(d)),c&&c(b,d.length-1),this},this.postCollection=function(a,b,c){var d=JSON.parse(window.localStorage.getItem(a));return d||(d=[]),b.each(function(a){d.push(a.attributes)}),window.localStorage.setItem(a,JSON.stringify(d)),c&&c(content,d.length),this},this.write=function(a,b,c){return window.localStorage.setItem(a,JSON.stringify(b)),c&&c(b),this},this.set=function(a,b,c){if(b){Array.isArray(b)||(b=[b]);var e=d.transaction([a],"readwrite");e.oncomplete=c,e.onerror=f;var g=e.objectStore(a);for(var h in b)var i=g.put(b[h]);return this}},this.update=function(){return this},this.updateById=function(){return this},this.remove=function(a,b,c,e){var f=d.transaction([a],"readwrite").objectStore(a).delete(b);return e&&(f.onsuccess=e),this},this.count=function(a){var b=JSON.parse(window.localStorage.getItem(a));return b?b.length:0},this.calc=function(){var a=0;for(var b in localStorage){var c=2*localStorage[b].length/1024/1024;a+=c,console.log(b,c.toFixed(4)+" MB")}return console.log("Total localStorage",a.toFixed(2)+" MB"),a.toFixed(2)}},IDBstores=function(a){console.log("Upgrading IDB.");var b,c=a.target.result;b=c.createObjectStore("settings",{keyPath:"key"}),b=c.createObjectStore("me",{keyPath:"id"}),b=c.createObjectStore("accounts",{keyPath:"id"}),b=c.createObjectStore("channels",{keyPath:"id"}),b.createIndex("type","type",{unique:!1}),b=c.createObjectStore("streams",{keyPath:"id"}),b.createIndex("type","token",{unique:!1}),b=c.createObjectStore("messages",{keyPath:"id"}),b.createIndex("stream","stream",{unique:!1}),b=c.createObjectStore("notifications",{keyPath:"id"}),b.createIndex("stream","stream",{unique:!1}),b=c.createObjectStore("users",{keyPath:"id"}),b.createIndex("name","displayname",{unique:!1}),b=c.createObjectStore("contacts",{keyPath:"id"}),b.createIndex("name","displayname",{unique:!1}),b=c.createObjectStore("campaigns",{keyPath:"id"}),b=c.createObjectStore("ping",{keyPath:"id"}),b=c.createObjectStore("touches",{keyPath:"id"})};Cloudwalkers.Session.Ping=Backbone.Model.extend({interval:3e4,min:1e4,max:9e4,timeout:0,cursor:!1,parameters:{},initialize:function(){Store.exists("ping",{id:this.id})||Store.post("ping",{id:this.id}),this.setCursor(!1),this.fetch({success:this.schedule.bind(this),error:this.toing}),this.on("change:paging",this.setCursor,this),this.on("change:updates",this.updateModels,this),this.on("change:add",this.addModels,this),this.on("change:remove",this.removeModels,this),this.listenTo(Cloudwalkers.Session,"ping",this.forceping)},ping:function(a){this.fetch({success:a?a:this.schedule.bind(this),error:this.toing.bind(this)})},setCursor:function(a,b){a?(this.interval+=Math.round(.2*(this.min-this.interval)),this.cursor=b.cursors.after,Store.set("ping",{id:this.id,cursor:this.cursor})):Store.get("ping",{id:this.id},function(a){a&&(this.cursor=a.cursor)}.bind(this))},url:function(){return this.cursor&&(this.parameters.after=this.cursor),CONFIG_BASE_URL+"json/account/"+this.id+"/ping?"+$.param(this.parameters)},parse:function(a){return a.pong},updateModels:function(a,b){b.accounts&&Cloudwalkers.Session.getAccounts().updates(b.accounts),b.streams&&Cloudwalkers.Session.getStreams().updates(b.streams),b.messages&&Cloudwalkers.Session.getMessages().updates(b.messages),b.notifications&&Cloudwalkers.Session.getNotifications().updates(b.notifications),b.users&&Cloudwalkers.Session.getUsers().updates(b.users),b.contacts&&Cloudwalkers.Session.getContacts().updates(b.contacts)},addModels:function(a,b){return b.length?void console.log("ping add callback: ",b):null},removeModels:function(a,b){return b.length?void console.log("ping remove callback: ",b):null},request:function(){window.clearTimeout(this.timeout),this.fetch({success:this.schedule.bind(this),error:this.toing.bind(this)})},schedule:function(){this.timeout=setTimeout(this.ping.bind(this),this.timer())},forceping:function(a){clearTimeout(this.timeout),this.schedule(),this.ping(a)},timer:function(){return this.interval+=Math.round(.05*(this.max-this.interval))},toing:function(){Cloudwalkers.RootView.growl(this.translateString("ping"),this.translateString("there_is_no_pong")),this.interval=this.max,this.schedule()},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)}}),$(function(){Cloudwalkers.Views.Dashboard=Cloudwalkers.Views.Pageview.extend({title:"Dashboard",widgets:[],initialize:function(){},render:function(){this.$el.html(Mustache.render(Templates.pageview,{title:this.title})),this.$container=this.$el.find("#container").eq(0);var a=new Cloudwalkers.Views.RecentAccounts;this.appendWidget(a,8);var b=new Cloudwalkers.Views.Status3dParty;return this.appendWidget(b,4),this}})}),$(function(){Cloudwalkers.Views.Little=Cloudwalkers.Views.Pageview.extend({title:"Little Ken",initialize:function(){},render:function(){return this.$el.html(Mustache.render(Templates.little_ken,{title:this.title})),this}})}),Cloudwalkers.Views.Navigation=Backbone.View.extend({events:{},initialize:function(){this.$header=$(".navbar-fixed-top").first()},render:function(){var a;return this.$el.html(Mustache.render(Templates.navigation,a)),this.handleSidebarMenu(),this.handleHeader(),this},handleHeader:function(){this.$header.find(".profile-avatar").css("background-image","url("+Cloudwalkers.Session.user.get("avatar")+")")},handleSidebarMenu:function(){var a=Backbone.history.fragment;return a?void this.setActive(a):null},setActive:function(a){$("#sidebar .active").removeClass("active"),$('a[href="#'+a+'"]').parents("#sidebar .page-sidebar-menu *").addClass("active")}}),Cloudwalkers.Views.Pageview=Backbone.View.extend({title:"Page",className:"container-fluid",span:0,widgets:[],widgetviews:[],events:{rendered:"bubblerender",remove:"destroy"},render:function(){return this.$el.html(Mustache.render(Templates.pageview,{title:this.title})),this.$container=this.$el.find("#widgetcontainer").eq(0),this.appendWidgets(),this},appendWidgets:function(){for(var a in this.widgets){var b=this.widgets[a].view(this.widgets[a].data);this.appendWidget(b,this.widgets[a].size)}},appendWidget:function(a,b){this.span&&0!==b||this.$container.append(Templates.row),this.span=b+this.span<12?b+this.span:0,a&&(this.$container.children().last().append(a.render().el),this.widgetviews.push(a),a.$el.addClass("col-md-"+b),a.negotiateFunctionalities&&a.negotiateFunctionalities())},appendhtml:function(a){this.$container.children().last().append(a)},cleanviews:function(){this.widgetviews.length&&(this.destroy(),this.widgetviews=[])},bubblerender:function(){this.trigger("rendered"),$.each(this.widgetviews,function(a,b){b.trigger("rendered")})},destroy:function(){$.each(this.widgetviews,function(a,b){b.remove()})}}),Cloudwalkers.Views.Root=Backbone.View.extend({view:null,header:null,footer:null,initialize:function(){this.navigation=new Cloudwalkers.Views.Navigation(this),$("#sidebar").html(this.navigation.render().el)},render:function(){return this.view?($("#page").html(this.view.render().el),this.view.$el.trigger("rendered"),this.view.finish&&this.view.finish(),void this.navigation.handleSidebarMenu()):null},setView:function(a){this.view&&this.view.remove(),Cloudwalkers.Session.trigger("destroy:view"),this.view=a,this.render(),Cloudwalkers.Session.manage()},viewshare:function(){this.share.show()},height:function(a){var b=$(window).height(),c=$(c).height();return a&&c>b?c:b},resize:function(){var a=this.height(!0);this.trigger("resize",a),$("#inner-content").css("min-height",a-42+"px")},popup_new:function(a){var b=a.render().el,c={title:a.title,actions:a.actions},d=$(Mustache.render(Templates.popup,c)).modal();d.find(".modal-body").html(b),a.actions&&d.find(".modal-footer [data-action]").on("click",function(a,b){this.trigger($(b.currentTarget).data("action"),a)}.bind(a,d)),d.on("hide",function(){this.remove()}.bind(a))},popup:function(a){var b=this,c=Templates.uipopup,d=$(c).modal();d.find(".modalcontainer").html(a.render().el),a.on("popup:close",function(){d.modal("hide")}),a.on("content:change",function(){b.trigger("content:change")})},compose:function(a){a?a.type="post":a={type:"post"};var b=new Cloudwalkers.Views.Compose(a);b.render().$el.modal({backdrop:"static"})},viewContact:function(a){a||(a=0);var b={contact:a},c=new Cloudwalkers.Views.ViewContact(b);c.render().$el.modal()},writeNote:function(a){var b={id:"compose",className:"modal hide note",thanks:!0,model:a},c=new Cloudwalkers.Views.ComposeNote(b);c.render().$el.modal()},writeMessage:function(a){a.preventDefault();var b={type:"post",redirect:!1},c=new Cloudwalkers.Views.Compose(b);this.setView(c)},editMessage:function(a){this.compose({model:a.clone(),redirect:!1})},writeDialog:function(a,b){var c=!0,d=b.parameters;this.compose("edit"==b.token?{model:a.clone(),clone:!1,redirect:!1}:{model:a.clone(),clone:c,actionparameters:d,redirect:!1,type:"post"})},shareMessage:function(a){this.compose({model:a.clone(),clone:!0,redirect:!1})},confirm:function(a,b,c){var d={};d.message=a,d.options=[{token:"confirm",label:this.translateString("yes"),description:"Confirm your action"}],d.translate_close=this.translateString("close");var e=Mustache.render(Templates.uiconfirm,d),f=$(e),g=f.modal();f.find("[data-response=confirm]").click(function(){b(),g.modal("hide")}),f.find("[data-dismiss=modal]").click(function(){c&&c()})},alert:function(a,b){var c={};c.message=a;var d=Mustache.render(Templates.uiconfirm,c),e=$(d),f=e.modal();e.find("[data-response=confirm]").click(function(){b(),f.modal("hide")})},growl:function(a,b){$.gritter.add({title:a,text:b,time:4e3})},information:function(a,b,c){c||(c="#inner-content .container-fluid"),$(c).prepend("<div class='alert alert-info'><button type='button' class='close' data-dismiss='alert'>&times;</button><strong>"+a+"</strong> "+b+"</div>")},closeInformation:function(){$("div.alert.alert-info").remove()},dialog:function(a,b,c){var d={};d.message=a,d.options=b;for(var e=Mustache.render(Templates.uidialog,d),f=$(e),g=f.modal(),h=function(a){f.find("[data-response="+a.token+"]").click(function(){c(a),g.modal("hide")})},i=0;i<b.length;i++)h(b[i])},imagePopups:function(){$("a.image-popup-viewer").fancybox()},resync:function(a){setTimeout(function(){Cloudwalkers.Router.Instance.navigate("#resync"),this.setView(new Cloudwalkers.Views.Resync({returnto:a,gofetch:!0}))}.bind(this))},oops:function(){Cloudwalkers.Router.Instance.navigate("#dashboard",!0),Cloudwalkers.RootView.growl(this.translateString("oops"),this.translateString("something_went_sideways"))},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)}}),Cloudwalkers.Views.RecentAccounts=Backbone.View.extend({events:{remove:"destroy","click .reload":"render"},initialize:function(a){a&&$.extend(this,a)},render:function(){var a={};this.$el.html(Mustache.render(Templates.recentaccounts,a)),this.collection=new Cloudwalkers.Collections.Accounts;var b=Backbone.Model.extend({}),c=Backbone.Collection.extend({model:b,url:"/js/territories.json"}),d=new c,e=[{name:"id",label:"ID",editable:!1,cell:Backgrid.IntegerCell.extend({orderSeparator:""})},{name:"name",label:"Name",cell:"string"},{name:"pop",label:"Population",cell:"integer"},{name:"percentage",label:"% of World Population",cell:"number"},{name:"date",label:"Date",cell:"date"},{name:"url",label:"URL",cell:"uri"}],f=new Backgrid.Grid({columns:e,collection:d});return this.$el.find("#backgrid").append(f.render().el),setTimeout(function(a){a.fetch({reset:!0})},1e3,d),this}}),Cloudwalkers.Views.Status3dParty=Backbone.View.extend({events:{remove:"destroy","click .reload":"render"},services:[{title:"3d Party Services"},{name:"GitHub API",api:"https://status.github.com/api/status.json?callback=apiStatus",link:"#",jsonp:!0,callback:"githubstatus"},{name:"Dploy.io API",api:null,callback:null},{name:"Mandrill API",api:null,callback:null},{name:"Ai-Applied API",api:null,callback:null},{title:"Social Content Services"},{name:"Titter API",api:null,callback:null},{name:"Facebook API",api:null,callback:"facebookstatus"},{name:"LinkedIn API",api:null,callback:null},{name:"Sendible API",api:null,callback:null},{name:"Klout API",api:null,callback:null}],initialize:function(a){a&&$.extend(this,a)},render:function(){var a={};return this.$el.html(Mustache.render(Templates.statusexternal,a)),this.services.forEach(function(a){var b;a.title?b=$("<div></div>").html(a.title).addClass("list-group-item list-group-item-info"):(b=$("<a></a>").html(a.name).addClass("list-group-item"),a.api?(b.attr("href",a.link),$.ajax({url:a.api,dataType:"jsonp",success:this[a.callback].bind(this,b)})):b.addClass("disabled")),this.$el.append(b)}.bind(this)),this},githubstatus:function(a,b){var c=$('<span class="badge"></span>').html(b.status).addClass("good"==b.status?"badge-green":"badge-red");a.prepend(c)},facebookstatus:function(a,b){console.log(b);var c=$('<span class="badge"></span>').html(b.status).addClass("good"==b.status?"badge-green":"badge-red");a.prepend(c)}}),AuthorizationError.prototype=new Error,AuthorizationError.prototype.constructor=AuthorizationError;var origin=function(){return window.location.origin?window.location.origin:window.location.protocol+"//"+window.location.hostname},config={appid:"oauth254117aa08b79a5.99870256",apiurl:"https://devapi.cloudwalkers.be/1/",authurl:"https://devapi.cloudwalkers.be/oauth2/",setloginwindow:function(){$("iframe").get(0).src=config.authurl+"authorize?response_type=token&state=xyz&client_id="+config.appid+"&redirect_uri="+origin()+"/auth.html"},hello:function(){window.location="/"},hasToken:function(){var a=window.localStorage.getItem("token");a&&a.length>9?config.hello():(a&&window.localStorage.removeItem("token"),config.setloginwindow(),window.addEventListener("message",config.receiveToken,!1))},receiveToken:function(a){a.origin===origin()&&(a.data&&a.data.length>9?(window.localStorage.setItem("token",a.data),config.hello()):config.setloginwindow())}},origin=function(){return window.location.origin?window.location.origin:window.location.protocol+"//"+window.location.hostname},config={appid:"oauth254117aa08b79a5.99870256",apiurl:"https://devapi.cloudwalkers.be/1/",authurl:"https://devapi.cloudwalkers.be/oauth2/",setloginwindow:function(){$("iframe").get(0).src=config.authurl+"authorize?response_type=token&state=xyz&client_id="+config.appid+"&redirect_uri="+origin()+"/auth.html"},hello:function(){window.location="/"},hasToken:function(){var a=window.localStorage.getItem("token");a&&a.length>9?config.hello():(a&&window.localStorage.removeItem("token"),config.setloginwindow(),window.addEventListener("message",config.receiveToken,!1))},receiveToken:function(a){a.origin===origin()&&(a.data&&a.data.length>9?(window.localStorage.setItem("token",a.data),config.hello()):config.setloginwindow())}},origin=function(){return window.location.origin?window.location.origin:window.location.protocol+"//"+window.location.hostname};